@{
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    ViewData["Title"] = "Bảng điều khiển - RealEstate";
}

<div class="container-fluid px-4 mt-4">
    <h2 class="fw-bold text-black mb-4">
        <i class="bi bi-speedometer2"></i> BẢNG ĐIỀU KHIỂN TỔNG QUAN
    </h2>

    <!-- ==== THỐNG KÊ TỔNG QUAN ==== -->
    <div class="row text-center mb-5" id="statsContainer">
        <div class="col-md-4 mb-3">
            <div class="card border-warning shadow-sm h-100">
                <div class="card-body">
                    <i class="bi bi-hourglass-split text-warning" style="font-size:2rem"></i>
                    <h6 class="text-muted mt-2">Bài đăng chờ duyệt</h6>
                    <h3 id="pendingCount" class="fw-bold text-warning">0</h3>
                    <a href="#" id="pendingDetail" class="btn btn-outline-warning btn-sm mt-2">Xem chi tiết</a>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-3">
            <div class="card border-success shadow-sm h-100">
                <div class="card-body">
                    <i class="bi bi-check-circle text-success" style="font-size:2rem"></i>
                    <h6 class="text-muted mt-2">Bài đăng đã duyệt / từ chối</h6>
                    <h3 id="approvedCount" class="fw-bold text-success">0</h3>
                    <a href="#" id="approvedDetail" class="btn btn-outline-success btn-sm mt-2">Xem chi tiết</a>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-3">
            <div class="card border-primary shadow-sm h-100">
                <div class="card-body">
                    <i class="bi bi-people-fill text-primary" style="font-size:2rem"></i>
                    <h6 class="text-muted mt-2">Tổng tài khoản người dùng</h6>
                    <h3 id="userCount" class="fw-bold text-primary">0</h3>
                    <a href="#" id="userDetail" class="btn btn-outline-primary btn-sm mt-2">Xem chi tiết</a>
                </div>
            </div>
        </div>
    </div>

    <!-- ==== BIỂU ĐỒ GIÁ TRỊ TRUNG BÌNH THEO TỈNH ==== -->
    <div class="card shadow-sm mb-5">
        <div class="card-header fw-bold text-primary">
            <i class="bi bi-graph-up"></i> Biểu đồ giá trung bình đất theo tỉnh
        </div>
        <div class="card-body">
            <canvas id="avgPriceChart" height="100"></canvas>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        async function loadStatistics() {
            const endpoints = [
                '/AdminStatistics/PendingPostsCount',
                '/AdminStatistics/ApprovedOrRejectedPostsCount',
                '/AdminStatistics/UserAccountsCount'
            ];

            try {
                const [pending, approved, users] = await Promise.all(
                    endpoints.map(url => fetch(url).then(r => r.json()))
                );

                document.getElementById('pendingCount').innerText = pending.count ?? pending.Count;
                document.getElementById('pendingDetail').href = pending.detailUrl ?? "#";

                document.getElementById('approvedCount').innerText = approved.count ?? approved.Count;
                document.getElementById('approvedDetail').href = approved.detailUrl ?? "#";

                document.getElementById('userCount').innerText = users.count ?? users.Count;
                document.getElementById('userDetail').href = users.detailUrl ?? "#";
            } catch (error) {
                console.error("Lỗi tải thống kê:", error);
            }
        }

        async function loadAveragePriceChart() {
            try {
                const res = await fetch('/AdminStatistics/AveragePriceByProvince');
                const data = await res.json();

                const provinces = data.map(x => x.province ?? x.Province);
                const prices = data.map(x => x.averagePrice ?? x.AveragePrice);

                const ctx = document.getElementById('avgPriceChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line', 
                    data: {
                        labels: provinces,
                        datasets: [{
                            label: 'Giá trung bình (VNĐ/m²)',
                            data: prices,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0,123,255,0.15)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4, 
                            pointRadius: 5,
                            pointBackgroundColor: '#007bff',
                            pointHoverRadius: 7,
                            pointHoverBackgroundColor: '#0056b3'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                callbacks: {
                                    label: ctx =>
                                        `${ctx.formattedValue.toLocaleString('vi-VN')} VNĐ/m²`
                                }
                            },
                            title: {
                                display: true,
                                text: 'Giá trung bình đất theo tỉnh (VNĐ/m²)',
                                font: { size: 16 }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: value => value.toLocaleString('vi-VN')
                                },
                                title: {
                                    display: true,
                                    text: 'Giá trung bình (VNĐ/m²)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Tỉnh / Thành phố'
                                },
                                ticks: {
                                    autoSkip: false,
                                    maxRotation: 60, 
                                    minRotation: 40
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Lỗi tải biểu đồ giá:", error);
            }
        }


        // === Gọi khi load trang ===
        loadStatistics();
        loadAveragePriceChart();
    </script>
}
