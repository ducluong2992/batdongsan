@{
    ViewData["Title"] = "Đổi mật khẩu";
    Layout = ViewData["Layout"]?.ToString();
    var indexController = ViewData["Layout"]?.ToString() == "_LayoutAdmin" ? "Admin" : "Home";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-5 col-md-7">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-body p-4">

                    <div class="text-center mb-4">
                        <i class="bi bi-shield-lock text-primary" style="font-size: 3rem;"></i>
                        <h3 class="mt-2 text-primary fw-bold">Đổi mật khẩu</h3>
                    </div>

                    <form asp-action="EditPassword" method="post">
                        @Html.AntiForgeryToken()

                        <div class="mb-3">
                            <label class="form-label fw-semibold"><i class="bi bi-key"></i> Mật khẩu cũ</label>
                            <input type="password" name="OldPassword" id="oldPassword" class="form-control" required />
                            <span id="oldPasswordError" class="text-danger small">
                                @ViewBag.ErrorOld
                            </span>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold"><i class="bi bi-lock"></i> Mật khẩu mới</label>
                            <input type="password" name="NewPassword" id="newPassword" class="form-control" required disabled />
                            <span class="text-danger small">@ViewBag.ErrorNew</span>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold"><i class="bi bi-lock-fill"></i> Xác nhận mật khẩu mới</label>
                            <input type="password" name="ConfirmPassword" id="confirmPassword" class="form-control" required disabled />
                            <span id="confirmError" class="text-danger small">@ViewBag.ErrorConfirm</span>
                        </div>
                        <div class="d-flex justify-content-center mt-4">
                            <button type="submit" class="btn btn-warning px-4 me-2">
                                <i class="bi bi-save"></i> Lưu thay đổi
                            </button>


                            <a asp-action="Index" asp-controller="@indexController" class="btn btn-outline-secondary px-4">
                                <i class="bi bi-arrow-left-circle"></i> Quay lại
                            </a>
                        </div>


                        @if (TempData["PasswordSuccess"] != null)
                        {
                            <div class="alert alert-success mt-3">@TempData["PasswordSuccess"]</div>
                        }
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const oldPasswordInput = document.getElementById("oldPassword");
    const oldPasswordError = document.getElementById("oldPasswordError");
    const newPass = document.getElementById("newPassword");
    const confirmPass = document.getElementById("confirmPassword");
    const confirmError = document.getElementById("confirmError");

    oldPasswordInput.addEventListener("blur", async () => {
        const value = oldPasswordInput.value.trim();
        if (!value) {
            oldPasswordError.textContent = "Vui lòng nhập mật khẩu cũ.";
            newPass.disabled = true;
            confirmPass.disabled = true;
            return;
        }

        oldPasswordError.textContent = "Đang kiểm tra...";
        const response = await fetch("@Url.Action("CheckOldPassword", "Account")", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `oldPassword=${encodeURIComponent(value)}`
        });
        const data = await response.json();

        if (!data.success) {
            oldPasswordError.textContent = "Mật khẩu cũ không đúng.";
            newPass.disabled = true;
            confirmPass.disabled = true;
            newPass.value = "";
            confirmPass.value = "";
        } else {
            oldPasswordError.textContent = "";
            newPass.disabled = false;
            confirmPass.disabled = false;
            newPass.focus();
        }
    });

    confirmPass.addEventListener("input", () => {
        if (newPass.value !== confirmPass.value) {
            confirmError.textContent = "Mật khẩu xác nhận không khớp.";
        } else {
            confirmError.textContent = "";
        }
    });
</script>
