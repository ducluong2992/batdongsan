@using System.Security.Claims
@inject bds.Data.ApplicationDbContext _context
@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - HHL RealEstate</title>

    <!-- CSS -->
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

    @RenderSection("Styles", required: false)

    <style>
        /* ====== GLOBAL ====== */
        body {
            font-family: "Segoe UI", sans-serif;
            background-color: #f8f9fa;
        }

        a {
            text-decoration: none;
        }

        /* ====== NAVBAR ====== */
        .navbar {
            background: linear-gradient(90deg, #7ee97a, #005c99, #a6e7ff);
            linear-gradient(90deg, #7ee97a, #005c99, #a6e7ff)
            border-bottom: 2px solid #e9ecef;
        }

        .navbar-brand span {
            font-size: 1.2rem;
            color: white;
        }

        .navbar-nav .nav-link {
            font-weight: 500;
            color: white;
            transition: all 0.25s ease;
            border-radius: 8px;
            padding: 8px 14px;
            position: relative;
        }

            .navbar-nav .nav-link:hover {
                color: #ffeb3b;
            }

            /* ===== GẠCH DƯỚI TRANG ACTIVE ===== */
            .navbar-nav .nav-link.active {
                color: #fff !important;
            }

                .navbar-nav .nav-link.active::after {
                    content: "";
                    position: absolute;
                    left: 0;
                    bottom: 0;
                    width: 100%;
                    height: 3px;
                    background-color: #ffeb3b;
                    border-radius: 3px;
                }

        .navbar-toggler {
            border: none;
        }

            .navbar-toggler:focus {
                box-shadow: none;
            }

        /* ====== BUTTONS ====== */
        .btn-outline-primary, .btn-success {
            display: flex;
            align-items: center;
            gap: 6px;
            border-radius: 8px;
            padding: 6px 12px;
        }

        .btn-outline-primary {
            border-color: #fff;
            color: #fff;
        }

            .btn-outline-primary:hover {
                background-color: #fff;
                color: #005c99;
            }

        .btn-success {
            background-color: #ffeb3b;
            color: #333;
            border: none;
        }

            .btn-success:hover {
                background-color: #ffe53b;
                color: #000;
            }

        /* ====== FOOTER ====== */
        footer {
            background-color: #1e1e1e;
            color: #ccc;
            padding: 40px 0;
            margin-top: 60px;
        }

            footer h5 {
                color: #fff;
                font-size: 1.1rem;
                margin-bottom: 15px;
            }

            footer a {
                color: #ccc;
                text-decoration: none;
                transition: color 0.3s;
            }

                footer a:hover {
                    color: #0d6efd;
                }

        .footer-bottom {
            border-top: 1px solid #444;
            margin-top: 25px;
            padding-top: 15px;
            font-size: 0.9rem;
            color: #999;
        }

        /* ====== RESPONSIVE ====== */
        @@media (max-width: 991px) {
            .navbar-nav .nav-link {
                margin: 3px 0;
            }
        }
    </style>
</head>

<body>
    <!-- ===== HEADER ===== -->
    <header>
        <nav class="navbar navbar-expand-lg shadow-sm"
             style="background: linear-gradient(90deg, #7ee97a, #005c99, #a3e0f5);">
            <div class="container-fluid px-4">
                <!-- Logo -->
                <a class="navbar-brand d-flex align-items-center" asp-controller="Home" asp-action="Index">
                    <img src="~/images/Logo/HHL2.png" alt="HHL RealEstate"
                         style="height:40px; margin-right:18px;">
                    <span class="fw-bold text-white" style="font-size:18px;">HHL RealEstate</span>
                </a>

                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                        data-bs-target="#navbarNav" aria-controls="navbarNav"
                        aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse justify-content-start" id="navbarNav">
                    <!-- Menu trái -->
                    <ul class="navbar-nav fw-semibold me-auto">
                        <li class="nav-item">
                            <a class="nav-link text-white @(ViewData["Title"]?.ToString() == "Trang chủ" ? "active-link" : "")"
                               asp-controller="Home" asp-action="Index">Trang chủ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white @(ViewData["Title"]?.ToString() == "Mua bán" ? "active-link" : "")"
                               asp-controller="Post" asp-action="Index">Mua bán</a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link text-white @(ViewData["Title"]?.ToString() == "Dự án" ? "active-link" : "")"
                               asp-controller="Project" asp-action="Index">Dự án</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white @(ViewData["Title"]?.ToString() == "Tin tức" ? "active-link" : "")"
                            <a class="nav-link" asp-controller="News" asp-action="Index">Tin tức</a>

                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white @(ViewData["Title"]?.ToString() == "Phân tích đánh giá" ? "active-link" : "")"
                               asp-controller="Analysis_Evaluation" asp-action="Index">Phân tích & Đánh giá</a>
                        </li>
                        @{
                            int unreadCount = 0;
                            if (User.Identity?.IsAuthenticated == true)
                            {
                                var userIdStr = User.FindFirstValue(ClaimTypes.NameIdentifier);
                                if (!string.IsNullOrEmpty(userIdStr) && int.TryParse(userIdStr, out int userId))
                                {
                                    unreadCount = _context.Notifications.Count(n => !n.IsRead && n.UserID == userId);
                                }
                            }
                        }

                        <li class="nav-item position-relative">
                            <a href="#" class="nav-link" id="notifToggle">
                                <i class="bi bi-bell text-light"></i>
                                @if (unreadCount > 0)
                                {
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">@unreadCount</span>
                                }
                            </a>
                            <!-- 🔔 Popup thông báo -->
                            <!-- 🔔 Popup thông báo -->
                            <div id="notifPanel" class="notification-panel shadow-lg">
                                <div class="header">
                                    <h6>Thông báo</h6>
                                    <button class="btn btn-sm btn-close-white" id="notifClose">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>

                                <div class="d-flex border-bottom">
                                    <button class="notif-tab flex-fill active" data-tab="all">Tất cả</button>
                                    <button class="notif-tab flex-fill" data-tab="unread">Chưa đọc</button>
                                </div>

                                <div id="notifContent" class="notif-scroll">
                                    <div class="p-3 text-center text-muted">Đang tải...</div>
                                </div>

                                <div class="footer">
                                    <a asp-controller="Notification" asp-action="Index">Xem tất cả thông báo</a>
                                </div>
                            </div>

                        </li>


                    </ul>

                    <!-- Menu phải -->
                    <ul class="navbar-nav align-items-center fw-semibold">
                        @if (User.Identity.IsAuthenticated)
                        {
                            <li class="nav-item me-2">
                                <a class="btn btn-success fw-semibold px-3" asp-controller="Post" asp-action="Create">
                                    <i class="bi bi-pencil-square me-1"></i> Đăng tin
                                </a>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle text-white d-flex align-items-center"
                                   href="#" role="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-person-circle me-1"></i> @User.Identity.Name
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 rounded-3">
                                    <li><a class="dropdown-item" asp-controller="Account" asp-action="Profile"><i class="bi bi-person-lines-fill me-2"></i>Thông tin cá nhân</a></li>
                                    <li><a class="dropdown-item" asp-controller="Post" asp-action="MyPosts"><i class="bi bi-file-earmark-text me-2"></i>Quản lý bài đăng</a></li>
                                    <li><a class="dropdown-item" asp-controller="Project" asp-action="MyProjects"><i class="bi bi-file-earmark-text me-2"></i>Dự án của tôi</a></li>
                                    <li><a class="dropdown-item" asp-controller="Prefered" asp-action="Index"><i class="bi bi-heart me-2"></i>Yêu thích</a></li>
                                    <li><a class="dropdown-item" asp-controller="Account" asp-action="EditPassword"><i class="bi bi-key me-2"></i>Đổi mật khẩu</a></li>
                                    <li><hr class="dropdown-divider" /></li>
                                    <li>
                                        <a class="dropdown-item text-danger d-flex align-items-center"
                                           asp-controller="Account" asp-action="Logout">
                                            <i class="bi bi-box-arrow-right me-2"></i> Đăng xuất
                                        </a>
                                    </li>
                                </ul>
                            </li>
                        }
                        else
                        {
                            <li class="nav-item me-2">
                                <a class="btn btn-outline-light fw-semibold px-3" asp-controller="Account" asp-action="Login">
                                    <i class="bi bi-box-arrow-in-right me-1"></i> Đăng nhập
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="btn btn-light fw-semibold px-3" asp-controller="Account" asp-action="Register">
                                    <i class="bi bi-pencil-square me-1"></i> Đăng ký
                                </a>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <style>
        /* ======= NAVBAR STYLE GỌN GÀNG, CHUẨN YÊU CẦU ======= */
        .navbar-nav .nav-item {
            margin: 0 6px;
        }

        .navbar-nav .nav-link {
            color: #fff !important;
            font-weight: 600;
            font-size: 1rem;
            position: relative;
            transition: all 0.25s ease;
            padding: 8px 10px;
            border-radius: 4px;
        }

            /* Hover: chuyển nền sáng nhẹ, không đổi sang xanh */
            .navbar-nav .nav-link:hover {
                background-color: rgba(255, 255, 255, 0.15);
                opacity: 0.95;
            }

            /* Active (trang hiện tại): có gạch trắng nhỏ ở dưới */
            .navbar-nav .nav-link.active-link::after {
                content: "";
                position: absolute;
                bottom: -3px;
                left: 0;
                height: 2px;
                width: 100%;
                background-color: #fff;
                border-radius: 1px;
            }

            /* Không hiện gạch khi hover qua item khác */
            .navbar-nav .nav-link:hover::after {
                width: 0;
            }

        /* Dropdown: tinh tế, không xanh */
        .dropdown-menu {
            border-radius: 10px;
            border: none;
            padding: 10px;
            animation: fadeIn 0.25s ease;
        }

        .dropdown-item {
            border-radius: 6px;
            font-weight: 500;
            color: #333 !important;
            transition: all 0.2s ease;
        }

            .dropdown-item:hover {
                background-color: rgba(0, 0, 0, 0.05);
                color: #005c99 !important;
            }

        @@keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @@media (max-width: 991px) {
            .navbar-nav .nav-link {
                margin: 4px 0;
            }
        }

        /* ===== 🔔 POPUP THÔNG BÁO CHUYÊN NGHIỆP ===== */
.notification-panel {
    position: absolute;
    top: 52px; /* ngay dưới chuông */
    right: 0;
    width: 380px;
    background-color: #fff;
    border-radius: 14px;
    display: none;
    overflow: hidden;
    z-index: 2000;
    box-shadow: 0 8px 28px rgba(0, 0, 0, 0.25);
    animation: notifSlideDown 0.25s ease-out;
}

/* Hiệu ứng mở mượt */
@@keyframes notifSlideDown {
    from {
        opacity: 0;
        transform: translateY(-8px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Thanh đầu popup */
.notification-panel .header {
    background: linear-gradient(90deg, #005c99, #00bcd4);
    color: #fff;
    padding: 10px 16px;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.notification-panel .header h6 {
    font-size: 1rem;
    margin: 0;
}

.notification-panel .header button {
    color: #fff;
    opacity: 0.8;
    transition: 0.2s;
}

.notification-panel .header button:hover {
    opacity: 1;
}

/* Tabs “Tất cả” / “Chưa đọc” */
.notif-tab {
    flex: 1;
    border: none;
    background: none;
    padding: 10px;
    font-weight: 600;
    color: #666;
    transition: all 0.2s ease;
}

.notif-tab.active {
    color: #005c99;
    border-bottom: 3px solid #005c99;
}

/* Danh sách thông báo */
.notif-scroll {
    max-height: 420px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: #ccc transparent;
}

/* item từng thông báo */
.notif-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 12px 16px;
    border-bottom: 1px solid #f2f2f2;
    transition: background 0.2s;
}

.notif-item:hover {
    background-color: #f9f9f9;
}

.notif-item.bg-light {
    background-color: #eef6ff;
}

.notif-text {
    flex: 1;
    margin-right: 8px;
}

.notif-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: #222;
}

.notif-message {
    font-size: 0.85rem;
    color: #555;
    margin-top: 2px;
}

.notif-time {
    font-size: 0.78rem;
    color: #999;
    margin-top: 4px;
}

.notif-dot {
    width: 10px;
    height: 10px;
    background-color: #0d6efd;
    border-radius: 50%;
    margin-top: 4px;
}

/* Footer */
.notification-panel .footer {
    border-top: 1px solid #eee;
    text-align: center;
    padding: 10px;
    background-color: #fafafa;
}

.notification-panel .footer a {
    font-weight: 600;
    color: #005c99;
    text-decoration: none;
}

.notification-panel .footer a:hover {
    text-decoration: underline;
}



    </style>


    <!-- ===== MAIN CONTENT ===== -->
    <main class="container mt-4">
        @RenderBody()
    </main>

    <!-- ===== FOOTER ===== -->
    <footer>
        <div class="container">
            <div class="row text-center text-md-start">
                <div class="col-md-4 mb-4">
                    <h5>Về HHL RealEstate</h5>
                    <p>HHL RealEstate là nền tảng bất động sản hàng đầu, cung cấp thông tin, phân tích và đánh giá chi tiết các dự án nhà ở, đất nền, biệt thự, chung cư...</p>
                </div>

                <div class="col-md-4 mb-4">
                    <h5>Liên hệ</h5>
                    <ul class="list-unstyled">
                        <li><i class="bi bi-geo-alt-fill me-2"></i> Group_09 - CNTT3 - K63 - UTC</li>
                        <li><i class="bi bi-envelope-fill me-2"></i> support@hhlrealestate.vn</li>
                        <li><i class="bi bi-telephone-fill me-2"></i> 0912 345 999</li>
                    </ul>
                </div>

                <div class="col-md-4 mb-4">
                    <h5>Kết nối với chúng tôi</h5>
                    <a href="#" class="me-3"><i class="bi bi-facebook fs-4"></i></a>
                    <a href="#" class="me-3"><i class="bi bi-instagram fs-4"></i></a>
                    <a href="#"><i class="bi bi-youtube fs-4"></i></a>
                </div>
            </div>

            <div class="footer-bottom text-center">
                © @DateTime.Now.Year HHL RealEstate.
            </div>
        </div>
    </footer>

    <!-- ===== SCRIPTS ===== -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>

    <script>
        $(function () {
            const panel = $('#notifPanel');
            const notifContent = $('#notifContent');
            const badge = $('#notifToggle .badge');

            // Hiển thị popup
            $('#notifToggle').on('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                panel.toggle();
                if (panel.is(':visible')) loadNotifications('all');
            });

            // Ẩn popup khi click ra ngoài
            $(document).on('click', function (e) {
                if (!$(e.target).closest('#notifPanel, #notifToggle').length) {
                    panel.hide();
                }
            });

            // Tab “Tất cả” / “Chưa đọc”
            $('.notif-tab').on('click', function () {
                $('.notif-tab').removeClass('active');
                $(this).addClass('active');
                loadNotifications($(this).data('tab'));
            });

            // AJAX load danh sách
            function loadNotifications(type) {
                notifContent.html('<div class="p-3 text-center text-muted">Đang tải...</div>');
                $.get('/Notification/GetLatest', { type: type }, function (res) {
                    if (!res.success || res.data.length === 0) {
                        notifContent.html('<div class="p-3 text-center text-muted">Không có thông báo nào.</div>');
                        return;
                    }

                    let html = '';
                    res.data.forEach(n => {
                        const link = n.postID
                            ? `/Post/Details/${n.postID}`
                            : (n.projectID ? `/Project/Details/${n.projectID}` : '#');
                        const date = new Date(n.createdAt).toLocaleString('vi-VN');
                        const isUnread = !n.isRead;

                        html += `
                            <a href="${link}" data-id="${n.notificationID}" class="notif-item ${isUnread ? 'bg-light' : ''}">
                                <div class="notif-text">
                                    <div class="notif-title">${n.title}</div>
                                    <div class="notif-message">${n.message}</div>
                                    <div class="notif-time">${date}</div>
                                </div>
                                ${isUnread ? '<div class="notif-dot"></div>' : ''}
                            </a>`;
                    });

                    html += `
                        <div class="border-top text-center py-2">
                            <button id="markAllRead" class="btn btn-sm btn-outline-secondary">Đánh dấu tất cả là đã đọc</button>
                        </div>`;
                    notifContent.html(html);
                });
            }

            // ✅ Khi click vào 1 thông báo → mark read
            $(document).on('click', '.notif-item', function () {
                const notifId = $(this).data('id');
                if (!notifId) return;

                $.post('/Notification/MarkAsRead', { id: notifId }, function () {
                    $(`[data-id="${notifId}"]`).removeClass('bg-light').find('.notif-dot').remove();
                    const currentCount = parseInt(badge.text()) || 0;
                    if (currentCount > 1) badge.text(currentCount - 1);
                    else badge.remove();
                });
            });

            // ✅ Khi click “Đánh dấu tất cả là đã đọc”
            $(document).on('click', '#markAllRead', function () {
                $.post('/Notification/MarkAllAsRead', function (res) {
                    if (res.success) {
                        $('.notif-item').removeClass('bg-light');
                        $('.notif-dot').remove();
                        badge.remove();
                    }
                });
            });
        });

    </script>



    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
