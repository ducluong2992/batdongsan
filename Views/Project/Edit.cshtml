@model bds.Models.Project
@{
    ViewData["Title"] = "Chỉnh sửa dự án";
}

<div class="container mt-4 mb-5">
    <div class="card shadow-lg border-0 rounded-4">
        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center rounded-top-4">
            <h4 class="mb-0"><i class="bi bi-pencil-square"></i> Chỉnh sửa dự án</h4>
            <a asp-action="MyProjects" asp-controller="Project" class="btn btn-light btn-sm">
                <i class="bi bi-arrow-left"></i> Quay lại
            </a>
        </div>

        <div class="card-body p-4">

            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success text-center fw-semibold shadow-sm rounded-pill" role="alert">
                    @TempData["SuccessMessage"]
                </div>
            }

            <form asp-action="Edit" method="post" enctype="multipart/form-data" class="mt-3">
                <input type="hidden" asp-for="ProjectID" />

                <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                <!-- Tên dự án -->
                <div class="mb-3">
                    <label asp-for="ProjectName" class="form-label fw-semibold">Tên dự án</label>
                    <input asp-for="ProjectName" class="form-control form-control-lg" />
                    <span asp-validation-for="ProjectName" class="text-danger"></span>
                </div>

                <!-- Mô tả (CKEditor) -->
                <div class="mb-3">
                    <label asp-for="Description" class="form-label fw-semibold">Mô tả chi tiết</label>
                    <textarea asp-for="Description" id="editor" class="form-control" rows="6"></textarea>
                    <span asp-validation-for="Description" class="text-danger"></span>
                </div>

                <script src="https://cdn.ckeditor.com/ckeditor5/41.3.1/classic/ckeditor.js"></script>

                <!-- Địa chỉ -->
                <div class="mb-3">
                    <label asp-for="Location" class="form-label fw-semibold">Địa chỉ (số nhà, tên đường)</label>
                    <input asp-for="Location" class="form-control" />
                </div>

                <!-- Dropdown khu vực -->
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Tỉnh/Thành phố</label>
                        <select id="ProvinceDropdown" class="form-select" asp-items="ViewBag.ProvinceList">
                            <option value="">-- Chọn Tỉnh/Thành phố --</option>
                        </select>
                    </div>

                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Quận/Huyện</label>
                        <select id="DistrictDropdown" class="form-select">
                            <option value="">-- Chọn Quận/Huyện --</option>
                        </select>
                    </div>

                    <div class="col-md-4 mb-3">
                        <label asp-for="CommuneID" class="form-label fw-semibold">Phường/Xã</label>
                        <select asp-for="CommuneID" id="CommuneDropdown" class="form-select">
                            <option value="">-- Chọn Phường/Xã --</option>
                        </select>
                    </div>
                </div>



                <!-- Diện tích và ngày -->
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label asp-for="Area" class="form-label fw-semibold">Diện tích (m²)</label>
                        <input asp-for="Area" class="form-control" type="number" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label asp-for="StartDate" class="form-label fw-semibold">Ngày bắt đầu</label>
                        <input asp-for="StartDate" class="form-control" type="date" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label asp-for="EndDate" class="form-label fw-semibold">Ngày kết thúc</label>
                        <input asp-for="EndDate" class="form-control" type="date" />
                    </div>
                </div>

                <!-- Ảnh -->
                <div class="mb-4">
                    <label class="form-label fw-semibold">Thay đại diện (nếu cần)</label>
                    <input type="file" name="images" class="form-control" multiple accept="image/*" />
                </div>

                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-warning btn-lg px-5 shadow-sm">
                        <i class="bi bi-save"></i> Lưu thay đổi (Chờ duyệt)
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
    <script>
        ClassicEditor
            .create(document.querySelector('#editor'), {
                toolbar: [
                    'heading', '|', 'bold', 'italic', 'link',
                    'bulletedList', 'numberedList', '|', 'blockQuote',
                    'insertTable', 'undo', 'redo'
                ],
            })
            .catch(error => console.error(error));
    </script>


    <script>
        $(document).ready(function () {
            const provinceId = "@ViewBag.ProvinceID";
            const districtId = "@ViewBag.DistrictID";
            const communeId = "@ViewBag.CommuneID";

            // --- Hàm nạp Quận/Huyện ---
            function loadDistricts(provinceId, selectedDistrictId, callback) {
                if (!provinceId) return;
                $.getJSON('/Project/GetDistrictsByProvinceId', { provinceId: provinceId })
                    .done(function (data) {
                        const districtDropdown = $("#DistrictDropdown");
                        districtDropdown.empty().append('<option value="">-- Chọn Quận/Huyện --</option>');
                        $.each(data, function (i, d) {
                            districtDropdown.append(`<option value="${d.id}" ${d.id == selectedDistrictId ? 'selected' : ''}>${d.name}</option>`);
                        });
                        if (callback) callback();
                    })
                    .fail(() => alert("Không thể tải danh sách Quận/Huyện"));
            }

            // --- Hàm nạp Phường/Xã ---
            function loadCommunes(districtId, selectedCommuneId) {
                if (!districtId) return;
                $.getJSON('/Project/GetCommunesByDistrictId', { districtId: districtId })
                    .done(function (data) {
                        const communeDropdown = $("#CommuneDropdown");
                        communeDropdown.empty().append('<option value="">-- Chọn Phường/Xã --</option>');
                        $.each(data, function (i, c) {
                            communeDropdown.append(`<option value="${c.id}" ${c.id == selectedCommuneId ? 'selected' : ''}>${c.name}</option>`);
                        });
                    })
                    .fail(() => alert("Không thể tải danh sách Phường/Xã"));
            }

            // --- Nếu có dữ liệu sẵn thì khởi tạo ---
            if (provinceId) {
                $("#ProvinceDropdown").val(provinceId);
                loadDistricts(provinceId, districtId, function () {
                    loadCommunes(districtId, communeId);
                });
            }

            // --- Khi chọn tỉnh ---
            $("#ProvinceDropdown").change(function () {
                const pId = $(this).val();
                $("#DistrictDropdown").empty().append('<option value="">-- Đang tải... --</option>');
                $("#CommuneDropdown").empty().append('<option value="">-- Chọn Quận/Huyện trước --</option>');
                if (pId) loadDistricts(pId, null, null);
            });

            // --- Khi chọn huyện ---
            $("#DistrictDropdown").change(function () {
                const dId = $(this).val();
                $("#CommuneDropdown").empty().append('<option value="">-- Đang tải... --</option>');
                if (dId) loadCommunes(dId, null);
            });
        });
    </script>

}
